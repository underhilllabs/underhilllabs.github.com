So your android app is out in the wild with thousands of Happy Users and the Happy Users are begging and pleading for a new feature that requires a new field in your database.   However, the aforementioned Happy Users, would quickly turn to Unhappy Users if your next upgrade wiped their data when it restructured the app's database.<br /><br />What to do?<br /><br />Here's how I upgraded my app's Database schema, while preserving all of the user's data.<br /><br />First of all, I use a DatabaseHelper class (that extends <a href="http://developer.android.com/intl/zh-TW/reference/android/database/sqlite/SQLiteOpenHelper.html">SQLiteOpenHelper</a>) that performs some of the basic database needs (create, upgrade).<br /><br />The function we will concentrate on in this post is onUpgrade().  This function is called when the database version, represent with the constant DATABASE_VERSION is changed.  Most barebones implementation of this function call will simply drop the app's tables  and recreate them with a call to onCreate():<br /><br /><blockquote><br /><span style="font-weight: bold;"><br /><pre><br />public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {<br />    ...<br />    db.execSQL("DROP TABLE IF EXISTS albums");<br />    onCreate(db);<br />}<br /></pre><br /></span><br /></blockquote><br /><br />However, this approach will destroy all of your user's data, (ie the entire 2500+ CD collection they painstakingly entered with the soft keybard--if this were the case perhaps you should add a barcode scanner intent, alas, back to the story.) Which results in a Very Unhappy User (hereafter VUU).<br /><br />The solution, is to check for the app's Database Version and make a call to our friend ALTER TABLE, like so.<br /><br /><blockquote><br /><span style="font-weight: bold;"><br /><pre><br />public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {<br />   if(oldVersion == 2) {<br />          db.execSQL("ALTER TABLE albums ADD COLUMN hip_again integer");<br />   } else {<br />         ...<br />        db.execSQL("DROP TABLE IF EXISTS albums");<br />        onCreate(db);<br />  }<br /></pre><br /></span><span style="font-weight: bold;">}</span><br /></blockquote><br /><br />There! Now your user's can flag their old CD's with the shifting tides of what's hip.  Also note that should add the column in the onCreate method.  So that Happy Users of the Future (hereafter HUF), will also have the field available to them:<br /><br /><blockquote><br /><span style="font-weight: bold;"><br /><pre><br />private static final String DATABASE_CREATE =<br />          "create table albums (_id integer primary key autoincrement, "<br />          ...<br />          + "hip_again integer);";<br /><br />@Override<br />public void onCreate(SQLiteDatabase db) {<br />                 db.execSQL(DATABASE_CREATE);<br />}<br /></pre><br /></span><br /></blockquote><br /><br />One final thing is to increment the constant DATABASE_VERSION, so that android will call onUpgrade() the next time the app is started:<br /><blockquote><br /><span style="font-weight: bold;"><br />private static final int DATABASE_VERSION = 3;<br /></span><br /></blockquote><br /><br /><br />That's it.<div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/7035860407900002000-5494733453019207090?l=denverdroid.blogspot.com' alt='' /></div>
